---
title: "QA Missing Codes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QA Missing Codes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mOMOP)
library(tidyverse)
```

This vignette takes a look at the Value Sets in the mCode Data Dictionary that are missing codes and how to handle them. We first get the data dictionary from the url found at http://hl7.org/implement/standards/fhir/us/mcode/index.html#Modeling and filter for the rows that are missing a Code value. 

```{r}
value_sets <- get_value_sets()
value_sets <-
  value_sets %>%
  filter(is.na(Code))
value_sets
```

There are 5 types of missing codes: 
1. SNOMED descendants of a specific SNOMED code  
2. 

```{r}
missing_codes_01 <-
value_sets %>%
  rubix::filter_at_grepl(col = `Logical Definition`,
                         grepl_phrase = "includes codes descending from") %>%
  select(ancestor_code = `Logical Definition`) %>%
  extract(col = ancestor_code,
          into = c("ancestor_code"),
          regex = "includes codes descending from ([0-9]{1,}) .*$",
          remove = TRUE)
missing_codes_01
```

```{r}
pg13::writeTable(conn_fun = "chariot::connectAthena()",
                 schema = "patelm9",
                 tableName = "mcode_snomed_ancestor_codes",
                 drop_existing = TRUE,
                 data = missing_codes_01)
```

```{r}
conn <- chariot::connectAthena()
missing_codes_01b <-
pg13::query(conn = conn,
            sql_statement = 
              "
              WITH snomed AS (
                SELECT * 
                FROM omop_vocabulary.concept c 
                WHERE c.vocabulary_id = 'SNOMED'
              )
              SELECT m.*, c2.* 
              FROM patelm9.mcode_snomed_ancestor_codes m 
              LEFT JOIN snomed s
              ON m.ancestor_code = s.concept_code 
              LEFT JOIN omop_vocabulary.concept_ancestor ca 
              ON ca.ancestor_concept_id = s.concept_id 
              LEFT JOIN omop_vocabulary.concept c2 
              ON c2.concept_id = ca.descendant_concept_id 
              ")
chariot::dcAthena(conn = conn)
```

